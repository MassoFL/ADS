{% extends "base.html" %}

{% block title %}Résultats - Générateur de Publicités IA{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="text-center mb-4">
            <h1 class="display-5 mb-3">
                <i class="fas fa-chart-line text-success me-3"></i>
                Suggestions Publicitaires
            </h1>
            <p class="lead text-muted">
                Basées sur l'analyse de votre contenu {{ source_type }}
            </p>
        </div>

        <!-- Aperçu du contenu -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="fas fa-eye me-2"></i>
                    Aperçu du contenu analysé
                </h6>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-0">{{ content_preview }}</p>
            </div>
        </div>

        <!-- Suggestions -->
        <div class="card shadow-lg">
            <div class="card-header gradient-bg">
                <h5 class="mb-0 text-white">
                    <i class="fas fa-lightbulb me-2"></i>
                    Suggestions de Publicités
                </h5>
            </div>
            <div class="card-body">
                <div class="suggestions-content" id="suggestionsContent">
                    {{ suggestions }}
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="text-center mt-4">
            <a href="{{ url_for('index') }}" class="btn btn-primary btn-lg me-3">
                <i class="fas fa-plus me-2"></i>
                Nouvelle Analyse
            </a>
            <button class="btn btn-outline-secondary btn-lg" onclick="copyResults()">
                <i class="fas fa-copy me-2"></i>
                Copier les Résultats
            </button>
        </div>

        <!-- Conseils -->
        <div class="row mt-5">
            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <h6 class="text-primary">
                            <i class="fas fa-tips me-2"></i>
                            Conseils d'utilisation
                        </h6>
                        <ul class="list-unstyled small text-muted">
                            <li><i class="fas fa-check text-success me-2"></i>Adaptez les messages à votre audience</li>
                            <li><i class="fas fa-check text-success me-2"></i>Testez différentes approches</li>
                            <li><i class="fas fa-check text-success me-2"></i>Respectez le contexte de l'article</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <h6 class="text-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Prochaines étapes
                        </h6>
                        <ul class="list-unstyled small text-muted">
                            <li><i class="fas fa-arrow-right text-info me-2"></i>Créez vos visuels publicitaires</li>
                            <li><i class="fas fa-arrow-right text-info me-2"></i>Définissez votre budget</li>
                            <li><i class="fas fa-arrow-right text-info me-2"></i>Lancez vos campagnes</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function copyResults() {
    const suggestionsText = document.querySelector('.suggestions-content').innerText;
    
    if (navigator.clipboard) {
        navigator.clipboard.writeText(suggestionsText).then(function() {
            showCopySuccess();
        }).catch(function() {
            fallbackCopy(suggestionsText);
        });
    } else {
        fallbackCopy(suggestionsText);
    }
}

function fallbackCopy(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    
    try {
        document.execCommand('copy');
        showCopySuccess();
    } catch (err) {
        alert('Impossible de copier le texte. Veuillez le sélectionner manuellement.');
    }
    
    document.body.removeChild(textArea);
}

function showCopySuccess() {
    const btn = event.target.closest('button');
    const originalContent = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-check me-2"></i>Copié !';
    btn.classList.remove('btn-outline-secondary');
    btn.classList.add('btn-success');
    
    setTimeout(() => {
        btn.innerHTML = originalContent;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-secondary');
    }, 2000);
}

// Format the suggestions content for better readability
document.addEventListener('DOMContentLoaded', function() {
    const suggestionsContent = document.getElementById('suggestionsContent');
    let text = suggestionsContent.textContent || suggestionsContent.innerText;
    
    // Clean up the text first
    text = text.trim();
    
    // Convert markdown-style formatting to HTML
    let html = text;
    
    // Fix broken strong tags and convert ** to proper HTML
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // Convert line breaks to HTML
    html = html.replace(/\n/g, '<br>');
    
    // Format headers (### text)
    html = html.replace(/###\s*(.*?)(<br>|$)/g, '<h5 class="text-primary mt-4 mb-3">$1</h5>');
    
    // Format numbered lists (1. 2. 3.)
    html = html.replace(/(\d+\.\s*<strong>.*?<\/strong>)/g, '<div class="mt-3 mb-2">$1</div>');
    
    // Format bullet points and sub-items
    html = html.replace(/^-\s/gm, '• ');
    html = html.replace(/<br>•\s/g, '<br><span class="text-muted">• </span>');
    
    // Format sections with dashes
    html = html.replace(/<br>---<br>/g, '<hr class="my-4">');
    
    // Add proper spacing for paragraphs
    html = html.replace(/(<br>){2,}/g, '<br><br>');
    
    // Style specific elements
    html = html.replace(/Type de produit\/service:/g, '<strong class="text-info">Type de produit/service:</strong>');
    html = html.replace(/Public cible:/g, '<strong class="text-success">Public cible:</strong>');
    html = html.replace(/Message publicitaire:/g, '<strong class="text-warning">Message publicitaire:</strong>');
    html = html.replace(/Pertinence:/g, '<strong class="text-danger">Pertinence:</strong>');
    
    // Clean up and set the formatted HTML
    html = html.replace(/^<br>/, ''); // Remove leading br
    suggestionsContent.innerHTML = html;
});
</script>
{% endblock %}